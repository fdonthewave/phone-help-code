{"generator":"Code Snippets v3.9.2","date_created":"2025-11-23 19:02","snippets":[{"id":6,"name":"Qualif Cardio Formulaire v5.5","code":"\/**\n * \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n * QUALIF CARDIO - FORMULAIRE COMPLET v5.3 AVEC CORRECTIONS\n * \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n * \n * \ud83d\udccb Shortcode : [qualif_cardio]\n * \ud83c\udfe5 Types RDV : \"1\u00e8re consultation prioritaire\" \/ \"risque faible\"\n * \ud83d\udcbe Sauvegarde COMPL\u00c8TE en BDD\n * \ud83d\udce7 Email auto via Brevo + fallback wp_mail\n * \ud83d\udeab Anti-doublons (hash unique)\n * \ud83d\udd0d Contr\u00f4le ZOOM : 70% par d\u00e9faut\n * \n * NOUVEAUT\u00c9S v5.3 :\n * \u26a1 Tabac : Facteur de risque uniquement si PA >= 1\n * \u26a1 JSON decode s\u00e9curis\u00e9 avec v\u00e9rification d'erreur\n * \u26a1 Cr\u00e9ation automatique table BDD\n * \u26a1 Fallback email wp_mail() si Brevo \u00e9choue\n * \u26a1 Commentaires m\u00e9tier pour maintenance\n * \n * PR\u00c9REQUIS wp-config.php :\n * - define('BREVO_API_KEY', 'ta-cle');\n * - define('BREVO_SENDER_EMAIL', 'scripts@phone-help.com');\n * - define('BREVO_SENDER_NAME', 'Qualif Cardio');\n * - define('BREVO_RECIPIENT_EMAIL', 'scripts@phone-help.com');\n * \n * \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n *\/\n\n\/\/ ============================================\n\/\/ CR\u00c9ATION TABLE BDD AU 1ER CHARGEMENT\n\/\/ ============================================\nif (!function_exists('qc_create_table')) {\n    function qc_create_table() {\n        global $wpdb;\n        $table = $wpdb->prefix . 'qualif_cardio_complete';\n        $charset = $wpdb->get_charset_collate();\n        \n        $sql = \"CREATE TABLE IF NOT EXISTS $table (\n            id bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT,\n            created_at datetime NOT NULL,\n            submission_hash varchar(32) NOT NULL,\n            age int(3) NOT NULL,\n            sexe varchar(10) NOT NULL,\n            taille int(3) NOT NULL,\n            poids decimal(5,2) NOT NULL,\n            imc decimal(4,2) NOT NULL,\n            medecin_adresseur varchar(255) NOT NULL,\n            commune varchar(255) NOT NULL,\n            suivi_cardio varchar(3) NOT NULL,\n            nom_cardiologue varchar(255) DEFAULT NULL,\n            q1_atcd varchar(3) NOT NULL,\n            q1_atcd_details text DEFAULT NULL,\n            q2_douleur_thoracique varchar(3) NOT NULL,\n            q3_essoufflement varchar(3) NOT NULL,\n            q4_claudication varchar(3) NOT NULL,\n            q5_diabete varchar(3) NOT NULL,\n            q6_hta varchar(3) NOT NULL,\n            q7_tabac varchar(3) NOT NULL,\n            q7_tabac_cigarettes int(3) DEFAULT NULL,\n            q7_tabac_annees int(3) DEFAULT NULL,\n            q7_tabac_pa decimal(5,2) DEFAULT NULL,\n            q8_cholesterol varchar(3) NOT NULL,\n            nb_facteurs_risque int(1) NOT NULL,\n            type_rdv varchar(100) NOT NULL,\n            notes_doctolib text NOT NULL,\n            email_sent tinyint(1) DEFAULT 0,\n            email_sent_at datetime DEFAULT NULL,\n            brevo_response text DEFAULT NULL,\n            ip_address varchar(45) NOT NULL,\n            user_agent varchar(255) NOT NULL,\n            PRIMARY KEY (id),\n            KEY submission_hash (submission_hash),\n            KEY created_at (created_at),\n            KEY email_sent (email_sent)\n        ) $charset;\";\n        \n        require_once(ABSPATH . 'wp-admin\/includes\/upgrade.php');\n        dbDelta($sql);\n        \n        error_log('\u2705 Qualif Cardio : Table cr\u00e9\u00e9e\/v\u00e9rifi\u00e9e');\n    }\n}\n\n\/\/ Ex\u00e9cuter la cr\u00e9ation de table au chargement du plugin\nadd_action('init', 'qc_create_table');\n\n\/\/ ============================================\n\/\/ CONFIGURATION CABINET\n\/\/ ============================================\nif (!function_exists('qc_get_config')) {\n    function qc_get_config() {\n        return array(\n            'nom_cabinet' => 'SMR Cardio Blois',\n            'couleur_primaire' => '#0596DE',\n            'couleur_secondaire' => '#004B87'\n        );\n    }\n}\n\n\/\/ ============================================\n\/\/ ENVOI EMAIL VIA BREVO + FALLBACK WP_MAIL\n\/\/ ============================================\nif (!function_exists('qc_send_brevo_email')) {\n    function qc_send_brevo_email($subject, $notes) {\n        $config = qc_get_config();\n        $full_subject = '[Qualif Cardio - ' . htmlspecialchars($config['nom_cabinet']) . '] ' . htmlspecialchars($subject);\n        \n        \/\/ Tentative Brevo si cl\u00e9 configur\u00e9e\n        if (defined('BREVO_API_KEY') && BREVO_API_KEY !== '') {\n            $api_key = BREVO_API_KEY;\n            $sender_email = defined('BREVO_SENDER_EMAIL') ? BREVO_SENDER_EMAIL : 'noreply@phone-help.com';\n            $sender_name = defined('BREVO_SENDER_NAME') ? BREVO_SENDER_NAME : 'Qualif Cardio';\n            $recipient_email = defined('BREVO_RECIPIENT_EMAIL') ? BREVO_RECIPIENT_EMAIL : 'scripts@phone-help.com';\n            \n            $html_content = '\n            <div style=\"font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; background: #f8f9fa;\">\n                <div style=\"background: linear-gradient(135deg, #0596DE 0%, #004B87 100%); padding: 30px; border-radius: 10px 10px 0 0;\">\n                    <h1 style=\"color: white; margin: 0; font-size: 28px; text-align: center;\">\ud83e\udec0 Qualif Cardio<\/h1>\n                    <p style=\"color: rgba(255,255,255,0.9); margin: 10px 0 0 0; text-align: center;\">' . htmlspecialchars($config['nom_cabinet']) . '<\/p>\n                <\/div>\n                <div style=\"background: white; padding: 30px; border-radius: 0 0 10px 10px;\">\n                    <div style=\"background: #0596DE; color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center;\">\n                        <h2 style=\"margin: 0;\">' . htmlspecialchars($subject) . '<\/h2>\n                    <\/div>\n                    <pre style=\"font-family: Courier New, monospace; font-size: 14px; line-height: 1.8; background: #f8fafc; padding: 25px; border-radius: 8px; border: 2px solid #0596DE; white-space: pre-wrap; color: #1e293b;\">' . htmlspecialchars($notes) . '<\/pre>\n                <\/div>\n                <div style=\"text-align: center; padding: 20px; color: #64748b; font-size: 12px;\">\n                    <p>Email automatique - Phone-Help<\/p>\n                <\/div>\n            <\/div>';\n            \n            $response = wp_remote_post('https:\/\/api.brevo.com\/v3\/smtp\/email', array(\n                'headers' => array(\n                    'api-key' => $api_key,\n                    'Content-Type' => 'application\/json'\n                ),\n                'body' => json_encode(array(\n                    'sender' => array('email' => $sender_email, 'name' => $sender_name),\n                    'to' => array(array('email' => $recipient_email)),\n                    'subject' => $full_subject,\n                    'htmlContent' => $html_content\n                )),\n                'timeout' => 15\n            ));\n            \n            if (!is_wp_error($response)) {\n                $status = wp_remote_retrieve_response_code($response);\n                if ($status === 201) {\n                    $body = json_decode(wp_remote_retrieve_body($response), true);\n                    $message_id = isset($body['messageId']) ? $body['messageId'] : 'unknown';\n                    error_log('\u2705 Qualif Cardio : Email Brevo envoy\u00e9 (ID: ' . $message_id . ')');\n                    return array('success' => true, 'message' => 'Email envoy\u00e9 via Brevo', 'message_id' => $message_id);\n                } else {\n                    error_log('\u26a0\ufe0f Qualif Cardio : Brevo Status ' . $status . ' - Tentative fallback wp_mail');\n                }\n            } else {\n                error_log('\u26a0\ufe0f Qualif Cardio : Brevo Error - ' . $response->get_error_message() . ' - Tentative fallback wp_mail');\n            }\n        }\n        \n        \/\/ FALLBACK : wp_mail si Brevo \u00e9choue ou non configur\u00e9\n        error_log('\ud83d\udce7 Qualif Cardio : Envoi fallback via wp_mail()');\n        \n        $recipient_email = defined('BREVO_RECIPIENT_EMAIL') ? BREVO_RECIPIENT_EMAIL : get_option('admin_email');\n        $headers = array('Content-Type: text\/html; charset=UTF-8');\n        \n        $html_simple = '<html><body style=\"font-family: Arial, sans-serif;\">';\n        $html_simple .= '<h2 style=\"color: #0596DE;\">\ud83e\udec0 ' . htmlspecialchars($full_subject) . '<\/h2>';\n        $html_simple .= '<pre style=\"background: #f8fafc; padding: 20px; border: 1px solid #cbd5e1; border-radius: 5px; font-size: 13px; line-height: 1.6;\">';\n        $html_simple .= htmlspecialchars($notes);\n        $html_simple .= '<\/pre>';\n        $html_simple .= '<p style=\"color: #64748b; font-size: 12px;\">Email automatique - Qualif Cardio (fallback wp_mail)<\/p>';\n        $html_simple .= '<\/body><\/html>';\n        \n        $wp_mail_result = wp_mail($recipient_email, $full_subject, $html_simple, $headers);\n        \n        if ($wp_mail_result) {\n            error_log('\u2705 Qualif Cardio : Email fallback wp_mail envoy\u00e9');\n            return array('success' => true, 'message' => 'Email envoy\u00e9 via wp_mail (fallback)', 'message_id' => 'wp_mail_fallback');\n        } else {\n            error_log('\u274c Qualif Cardio : \u00c9chec wp_mail - Aucun email envoy\u00e9');\n            return array('success' => false, 'message' => '\u00c9chec Brevo et wp_mail');\n        }\n    }\n}\n\n\/\/ ============================================\n\/\/ HANDLER AJAX - Enregistrement BDD + Email\n\/\/ ============================================\nif (!function_exists('qc_handle_submit')) {\n    function qc_handle_submit() {\n        \/\/ V\u00e9rification nonce\n        if (!isset($_POST['nonce']) || !wp_verify_nonce($_POST['nonce'], 'qualif_cardio_nonce')) {\n            wp_send_json_error(array('message' => 'S\u00e9curit\u00e9 : nonce invalide'));\n        }\n        \n        \/\/ Honeypot anti-spam\n        if (!empty($_POST['website'])) {\n            wp_send_json_error(array('message' => 'Spam d\u00e9tect\u00e9'));\n        }\n        \n        \/\/ D\u00e9codage JSON S\u00c9CURIS\u00c9 avec v\u00e9rification\n        $json_raw = stripslashes($_POST['data']);\n        $data = json_decode($json_raw, true);\n        \n        if (!$data || json_last_error() !== JSON_ERROR_NONE) {\n            error_log('\u274c Qualif Cardio : JSON invalide - ' . json_last_error_msg());\n            wp_send_json_error(array('message' => 'Donn\u00e9es corrompues (JSON invalide)'));\n        }\n        \n        \/\/ Validation basique des champs obligatoires\n        $required_fields = array('age', 'sexe', 'taille', 'poids', 'commune', 'type_rdv', 'notes_doctolib');\n        foreach ($required_fields as $field) {\n            if (empty($data[$field])) {\n                wp_send_json_error(array('message' => 'Champ obligatoire manquant : ' . $field));\n            }\n        }\n        \n        global $wpdb;\n        $table = $wpdb->prefix . 'qualif_cardio_complete';\n        \n        \/\/ Anti-doublon : Hash sur 5 minutes (acceptable car rare selon retour utilisateur)\n        $hash = md5(\n            $data['age'] . $data['sexe'] . $data['poids'] . $data['taille'] . \n            floor(time() \/ 300)\n        );\n        \n        $recent = $wpdb->get_var($wpdb->prepare(\n            \"SELECT id FROM $table WHERE submission_hash = %s LIMIT 1\",\n            $hash\n        ));\n        \n        if ($recent) {\n            wp_send_json_error(array('message' => 'Doublon d\u00e9tect\u00e9 (< 5 min)'));\n        }\n        \n        \/\/ Insertion BDD\n        $inserted = $wpdb->insert($table, array(\n            'created_at' => current_time('mysql'),\n            'submission_hash' => $hash,\n            'age' => intval($data['age']),\n            'sexe' => sanitize_text_field($data['sexe']),\n            'taille' => intval($data['taille']),\n            'poids' => floatval($data['poids']),\n            'imc' => floatval($data['imc']),\n            'medecin_adresseur' => sanitize_text_field($data['medecin_adresseur']),\n            'commune' => sanitize_text_field($data['commune']),\n            'suivi_cardio' => sanitize_text_field($data['suivi_cardio']),\n            'nom_cardiologue' => sanitize_text_field($data['nom_cardiologue']),\n            'q1_atcd' => sanitize_text_field($data['q1_atcd']),\n            'q1_atcd_details' => sanitize_textarea_field($data['q1_atcd_details']),\n            'q2_douleur_thoracique' => sanitize_text_field($data['q2_dt']),\n            'q3_essoufflement' => sanitize_text_field($data['q3_esso']),\n            'q4_claudication' => sanitize_text_field($data['q4_claud']),\n            'q5_diabete' => sanitize_text_field($data['q5_diab']),\n            'q6_hta' => sanitize_text_field($data['q6_hta']),\n            'q7_tabac' => sanitize_text_field($data['q7_tabac']),\n            'q7_tabac_cigarettes' => !empty($data['q7_tabac_cigarettes']) ? intval($data['q7_tabac_cigarettes']) : null,\n            'q7_tabac_annees' => !empty($data['q7_tabac_annees']) ? intval($data['q7_tabac_annees']) : null,\n            'q7_tabac_pa' => !empty($data['q7_tabac_pa']) ? floatval($data['q7_tabac_pa']) : null,\n            'q8_cholesterol' => sanitize_text_field($data['q8_chol']),\n            'nb_facteurs_risque' => intval($data['nb_facteurs']),\n            'type_rdv' => sanitize_text_field($data['type_rdv']),\n            'notes_doctolib' => sanitize_textarea_field($data['notes_doctolib']),\n            'ip_address' => $_SERVER['REMOTE_ADDR'],\n            'user_agent' => substr($_SERVER['HTTP_USER_AGENT'], 0, 255)\n        ));\n        \n        if (!$inserted) {\n            error_log('\u274c Qualif Cardio : Erreur BDD - ' . $wpdb->last_error);\n            wp_send_json_error(array('message' => 'Erreur BDD : ' . $wpdb->last_error));\n        }\n        \n        $insert_id = $wpdb->insert_id;\n        error_log('\u2705 Qualif Cardio : Enregistrement BDD ID=' . $insert_id);\n        \n        \/\/ Envoi email (Brevo + fallback wp_mail)\n        $email_result = qc_send_brevo_email($data['type_rdv'], $data['notes_doctolib']);\n        \n        if ($email_result['success']) {\n            $wpdb->update($table, array(\n                'email_sent' => 1,\n                'email_sent_at' => current_time('mysql'),\n                'brevo_response' => 'Message ID: ' . $email_result['message_id']\n            ), array('id' => $insert_id));\n        }\n        \n        $message = 'Qualification enregistr\u00e9e !';\n        if ($email_result['success']) {\n            $message .= ' Email envoy\u00e9 avec succ\u00e8s.';\n        } else {\n            $message .= ' (Email non envoy\u00e9 : ' . $email_result['message'] . ')';\n        }\n        \n        wp_send_json_success(array(\n            'message' => $message,\n            'id' => $insert_id,\n            'email_sent' => $email_result['success']\n        ));\n    }\n}\nadd_action('wp_ajax_qc_submit', 'qc_handle_submit');\nadd_action('wp_ajax_nopriv_qc_submit', 'qc_handle_submit');\n\n\/\/ ============================================\n\/\/ SHORTCODE PRINCIPAL\n\/\/ ============================================\nif (!function_exists('qc_shortcode')) {\n    function qc_shortcode() {\n        $config = qc_get_config();\n        $nonce = wp_create_nonce('qualif_cardio_nonce');\n        $ajax_url = admin_url('admin-ajax.php');\n        \n        ob_start();\n        ?>\n<style>\n    * { box-sizing: border-box; }\n    .qc-wrapper { \n        max-width: 1600px; \n        margin: 20px auto; \n        padding: 20px; \n        transition: zoom 0.2s ease;\n    }\n    \n    \/* ============================================ *\/\n    \/* CONTR\u00d4LES ZOOM - DANS LE BLOC PATIENT *\/\n    \/* ============================================ *\/\n    .qc-patient { \n        background: white; \n        padding: 20px; \n        border-radius: 12px; \n        margin-bottom: 20px; \n        box-shadow: 0 2px 10px rgba(0,0,0,0.08); \n        border-left: 5px solid <?php echo $config['couleur_primaire']; ?>;\n        position: relative;\n    }\n    \n    .qc-zoom-controls {\n        position: absolute;\n        top: 20px;\n        right: 20px;\n        z-index: 100;\n        background: white;\n        border-radius: 12px;\n        box-shadow: 0 4px 20px rgba(0,0,0,0.2);\n        padding: 10px;\n        display: flex;\n        flex-direction: column;\n        gap: 8px;\n        border: 3px solid <?php echo $config['couleur_primaire']; ?>;\n    }\n    \n    .qc-zoom-btn {\n        width: 45px;\n        height: 45px;\n        border: none;\n        background: linear-gradient(135deg, <?php echo $config['couleur_primaire']; ?> 0%, <?php echo $config['couleur_secondaire']; ?> 100%);\n        color: white;\n        font-size: 24px;\n        font-weight: 900;\n        border-radius: 8px;\n        cursor: pointer;\n        transition: all 0.2s;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n    }\n    \n    .qc-zoom-btn:hover {\n        transform: scale(1.1);\n        box-shadow: 0 4px 12px rgba(5, 150, 222, 0.5);\n    }\n    \n    .qc-zoom-btn:active {\n        transform: scale(0.95);\n    }\n    \n    .qc-zoom-value {\n        text-align: center;\n        font-size: 13px;\n        font-weight: 800;\n        color: <?php echo $config['couleur_primaire']; ?>;\n        padding: 4px 0;\n        cursor: pointer;\n        transition: all 0.2s;\n    }\n    \n    .qc-zoom-value:hover {\n        color: <?php echo $config['couleur_secondaire']; ?>;\n        text-decoration: underline;\n    }\n    \n    .qc-patient-title { font-size: 16px; font-weight: 800; color: <?php echo $config['couleur_primaire']; ?>; margin-bottom: 15px; text-transform: uppercase; }\n    .qc-patient-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }\n    .qc-patient-grid .qc-field-full { grid-column: span 4; }\n    .qc-patient-grid .qc-field-half { grid-column: span 2; }\n    .qc-field { display: flex; flex-direction: column; gap: 5px; }\n    .qc-label { font-weight: 700; font-size: 13px; color: #1e293b; }\n    .qc-label-required::after { content: ' *'; color: #dc2626; }\n    .qc-input, .qc-select { padding: 8px 10px; border: 2px solid #cbd5e1; border-radius: 6px; font-size: 14px; font-weight: 600; color: #1e293b; transition: all 0.2s; }\n    .qc-input:focus, .qc-select:focus { outline: none; border-color: <?php echo $config['couleur_primaire']; ?>; box-shadow: 0 0 0 3px rgba(5, 150, 222, 0.15); }\n    .qc-main-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px; }\n    .qc-section { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); display: flex; flex-direction: column; min-height: 520px; }\n    .qc-section-atcd { border-left: 5px solid #dc2626; }\n    .qc-section-symptomes { border-left: 5px solid #f59e0b; }\n    .qc-section-fdr { border-left: 5px solid #10b981; }\n    .qc-section-header { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; padding-bottom: 12px; border-bottom: 3px solid #e2e8f0; }\n    .qc-section-icon { font-size: 28px; }\n    .qc-section-title { font-size: 16px; font-weight: 900; color: #1e293b; text-transform: uppercase; letter-spacing: 0.5px; margin: 0; }\n    .qc-question { background: #f8fafc; padding: 12px; border-radius: 8px; margin-bottom: 10px; border: 2px solid #e2e8f0; transition: all 0.2s; }\n    .qc-question:hover { border-color: #cbd5e1; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }\n    .qc-question-text { font-size: 14px; font-weight: 700; color: #1e293b; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }\n    .qc-q-number { display: inline-flex; align-items: center; justify-content: center; background: <?php echo $config['couleur_primaire']; ?>; color: white; width: 24px; height: 24px; border-radius: 50%; font-weight: 900; font-size: 13px; flex-shrink: 0; }\n    .qc-radio-group { display: flex; gap: 8px; flex-wrap: wrap; }\n    .qc-radio-item { flex: 1; min-width: 70px; display: flex; align-items: center; justify-content: center; gap: 6px; padding: 10px 16px; background: white; border-radius: 6px; cursor: pointer; transition: all 0.2s; border: 2px solid #e2e8f0; position: relative; }\n    .qc-radio-item:hover { background: #f1f5f9; border-color: #cbd5e1; }\n    .qc-radio-item.selected { background: #dbeafe; border-color: <?php echo $config['couleur_primaire']; ?>; box-shadow: 0 0 0 3px rgba(5, 150, 222, 0.1); }\n    .qc-radio { position: absolute; opacity: 0; width: 0; height: 0; }\n    .qc-radio-label { font-weight: 700; font-size: 14px; cursor: pointer; color: #334155; margin: 0; width: 100%; text-align: center; }\n    .qc-panel { margin-top: 8px; padding: 12px; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px; display: none; }\n    .qc-panel-title { font-weight: 700; font-size: 12px; color: #92400e; margin-bottom: 8px; }\n    .qc-checkbox-list { display: flex; flex-direction: column; gap: 6px; }\n    .qc-checkbox-item { display: flex; align-items: center; gap: 8px; padding: 6px; background: white; border-radius: 4px; cursor: pointer; transition: all 0.2s; font-size: 13px; font-weight: 600; }\n    .qc-checkbox-item:hover { background: #fef9c3; }\n    .qc-checkbox-item input[type=\"checkbox\"] { cursor: pointer; accent-color: #dc2626; }\n    .qc-input-inline { flex: 1; padding: 4px 8px; border: 1px solid #d4d4d8; border-radius: 4px; font-size: 12px; margin-left: 6px; }\n    .qc-tabac-profiles { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 10px; }\n    .qc-profile-item { cursor: pointer; }\n    .qc-profile-item input[type=\"radio\"] { display: none; }\n    .qc-profile-box { background: white; padding: 10px; border-radius: 6px; border: 2px solid #e2e8f0; text-align: center; transition: all 0.2s; }\n    .qc-profile-item input:checked + .qc-profile-box { background: #dbeafe; border-color: <?php echo $config['couleur_primaire']; ?>; box-shadow: 0 0 0 3px rgba(5, 150, 222, 0.1); }\n    .qc-profile-label { font-weight: 800; font-size: 13px; color: #1e293b; margin-bottom: 4px; }\n    .qc-profile-detail { font-size: 11px; color: #64748b; margin-bottom: 4px; }\n    .qc-profile-pa { font-size: 13px; font-weight: 700; color: #0596DE; }\n    .qc-tabac-perso { display: block; }\n    .qc-panel-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }\n    .qc-pa-result { background: white; padding: 8px; border-radius: 6px; text-align: center; font-size: 15px; font-weight: 800; color: #92400e; margin-top: 8px; display: none; }\n    .qc-actions { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); }\n    .qc-buttons { display: grid; grid-template-columns: 2fr 1fr; gap: 15px; }\n    .qc-button { padding: 16px; background: linear-gradient(135deg, <?php echo $config['couleur_primaire']; ?> 0%, <?php echo $config['couleur_secondaire']; ?> 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 800; cursor: pointer; transition: all 0.3s; text-transform: uppercase; letter-spacing: 0.5px; box-shadow: 0 4px 12px rgba(5, 150, 222, 0.4); }\n    .qc-button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(5, 150, 222, 0.6); }\n    .qc-button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }\n    .qc-button-reset { background: linear-gradient(135deg, #64748b 0%, #475569 100%); box-shadow: 0 4px 12px rgba(100, 116, 139, 0.4); }\n    .qc-button-reset:hover:not(:disabled) { box-shadow: 0 6px 16px rgba(100, 116, 139, 0.6); }\n    .qc-result { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.95); z-index: 9999; overflow-y: auto; animation: fadeIn 0.3s ease-out; }\n    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }\n    .qc-result-content { max-width: 900px; margin: 40px auto; padding: 40px; }\n    .qc-result-grid { display: flex; flex-direction: column; gap: 30px; }\n    .qc-rdv-box { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); padding: 50px; border-radius: 20px; text-align: center; border: 6px solid #d97706; box-shadow: 0 10px 40px rgba(251, 191, 36, 0.6); margin-bottom: 30px; }\n    .qc-rdv-label { font-size: 18px; font-weight: 700; color: #000; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 20px; }\n    .qc-rdv-value { font-size: 42px; font-weight: 900; color: #000; text-transform: uppercase; text-shadow: 3px 3px 6px rgba(0,0,0,0.2); line-height: 1.3; }\n    .qc-notes-container { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }\n    .qc-notes-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 4px solid <?php echo $config['couleur_primaire']; ?>; }\n    .qc-notes-title { font-size: 22px; font-weight: 900; color: <?php echo $config['couleur_primaire']; ?>; text-transform: uppercase; margin: 0; }\n    .qc-copy-btn { padding: 15px 30px; background: <?php echo $config['couleur_primaire']; ?>; color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 800; cursor: pointer; transition: all 0.3s; text-transform: uppercase; }\n    .qc-copy-btn:hover { background: <?php echo $config['couleur_secondaire']; ?>; transform: translateY(-3px); box-shadow: 0 6px 20px rgba(5, 150, 222, 0.5); }\n    .qc-notes { background: #f8fafc; border: 3px solid #cbd5e1; border-radius: 10px; padding: 25px; white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 15px; line-height: 1.8; color: #000; font-weight: 600; }\n    .qc-result-actions { display: flex; justify-content: center; gap: 20px; margin-top: 30px; }\n    .qc-new-qualif-btn { padding: 18px 40px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: 900; cursor: pointer; transition: all 0.3s; text-transform: uppercase; box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4); }\n    .qc-new-qualif-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(16, 185, 129, 0.6); }\n    .qc-alert { padding: 12px 18px; border-radius: 8px; margin-top: 15px; font-weight: 700; font-size: 14px; display: none; }\n    .qc-alert-success { background: #d1fae5; color: #065f46; border: 2px solid #10b981; }\n    .qc-alert-error { background: #fee2e2; color: #991b1b; border: 2px solid #ef4444; }\n    .qc-honeypot { position: absolute; left: -9999px; opacity: 0; }\n<\/style>\n\n<div class=\"qc-wrapper\">\n    <div class=\"qc-form-container\">\n    <form id=\"qc-form\">\n        <input type=\"text\" name=\"website\" class=\"qc-honeypot\" tabindex=\"-1\" autocomplete=\"off\">\n        \n        <div class=\"qc-patient\">\n            <div class=\"qc-zoom-controls\">\n                <button type=\"button\" class=\"qc-zoom-btn\" id=\"qc-zoom-plus\" title=\"Zoomer (Ctrl +)\">+<\/button>\n                <div class=\"qc-zoom-value\" id=\"qc-zoom-display\" title=\"Double-clic pour r\u00e9initialiser\">70%<\/div>\n                <button type=\"button\" class=\"qc-zoom-btn\" id=\"qc-zoom-minus\" title=\"D\u00e9zoomer (Ctrl -)\">\u2212<\/button>\n            <\/div>\n            \n            <div class=\"qc-patient-title\">\ud83d\udccb Informations Patient<\/div>\n            <div class=\"qc-patient-grid\">\n                <div class=\"qc-field\">\n                    <label class=\"qc-label qc-label-required\">\u00c2ge<\/label>\n                    <input type=\"number\" name=\"age\" class=\"qc-input\" min=\"0\" max=\"120\" required>\n                <\/div>\n                <div class=\"qc-field\">\n                    <label class=\"qc-label qc-label-required\">Sexe<\/label>\n                    <div class=\"qc-radio-group\">\n                        <label class=\"qc-radio-item\">\n                            <input type=\"radio\" name=\"sexe\" value=\"Homme\" id=\"sexe-h\" class=\"qc-radio\" required>\n                            <span class=\"qc-radio-label\">H<\/span>\n                        <\/label>\n                        <label class=\"qc-radio-item\">\n                            <input type=\"radio\" name=\"sexe\" value=\"Femme\" id=\"sexe-f\" class=\"qc-radio\">\n                            <span class=\"qc-radio-label\">F<\/span>\n                        <\/label>\n                    <\/div>\n                <\/div>\n                <div class=\"qc-field\">\n                    <label class=\"qc-label qc-label-required\">Taille (cm)<\/label>\n                    <input type=\"number\" name=\"taille\" class=\"qc-input\" min=\"50\" max=\"250\" required>\n                <\/div>\n                <div class=\"qc-field\">\n                    <label class=\"qc-label qc-label-required\">Poids (kg)<\/label>\n                    <input type=\"number\" name=\"poids\" class=\"qc-input\" min=\"20\" max=\"300\" required>\n                <\/div>\n                \n                <div class=\"qc-field qc-field-half\">\n                    <label class=\"qc-label qc-label-required\">M\u00e9decin adresseur<\/label>\n                    <div class=\"qc-radio-group\">\n                        <label class=\"qc-radio-item\">\n                            <input type=\"radio\" name=\"adresseur_type\" value=\"M\u00e9decin traitant\" id=\"adresseur-mt\" class=\"qc-radio\" required checked>\n                            <span class=\"qc-radio-label\">M\u00e9decin traitant<\/span>\n                        <\/label>\n                        <label class=\"qc-radio-item\">\n                            <input type=\"radio\" name=\"adresseur_type\" value=\"Autre\" id=\"adresseur-autre\" class=\"qc-radio\">\n                            <span class=\"qc-radio-label\">Autre<\/span>\n                        <\/label>\n                    <\/div>\n                <\/div>\n                <div class=\"qc-field qc-field-half\" id=\"adresseur-autre-field\" style=\"display: none;\">\n                    <label class=\"qc-label\">Nom du m\u00e9decin<\/label>\n                    <input type=\"text\" name=\"adresseur_nom\" class=\"qc-input\" placeholder=\"Nom du m\u00e9decin\">\n                <\/div>\n                \n                <div class=\"qc-field qc-field-half\">\n                    <label class=\"qc-label qc-label-required\">Commune de R\u00e9sidence<\/label>\n                    <input type=\"text\" name=\"commune\" class=\"qc-input\" required>\n                <\/div>\n                \n                <div class=\"qc-field qc-field-half\">\n                    <label class=\"qc-label qc-label-required\">Suivi cardio ?<\/label>\n                    <div class=\"qc-radio-group\">\n                        <label class=\"qc-radio-item\">\n                            <input type=\"radio\" name=\"suivi_cardio\" value=\"NON\" id=\"suivi-non\" class=\"qc-radio\" required checked>\n                            <span class=\"qc-radio-label\">NON<\/span>\n                        <\/label>\n                        <label class=\"qc-radio-item\">\n                            <input type=\"radio\" name=\"suivi_cardio\" value=\"OUI\" id=\"suivi-oui\" class=\"qc-radio\">\n                            <span class=\"qc-radio-label\">OUI<\/span>\n                        <\/label>\n                    <\/div>\n                <\/div>\n                \n                <div class=\"qc-field qc-field-full\" id=\"cardio-field\" style=\"display: none;\">\n                    <label class=\"qc-label\">Nom cardiologue<\/label>\n                    <div class=\"qc-radio-group\" style=\"max-width: 400px;\">\n                        <label class=\"qc-radio-item\">\n                            <input type=\"radio\" name=\"cardio_type\" value=\"Cabinet\" id=\"cardio-cabinet\" class=\"qc-radio\">\n                            <span class=\"qc-radio-label\">Cabinet<\/span>\n                        <\/label>\n                        <label class=\"qc-radio-item\">\n                            <input type=\"radio\" name=\"cardio_type\" value=\"Autre\" id=\"cardio-autre\" class=\"qc-radio\">\n                            <span class=\"qc-radio-label\">Autre<\/span>\n                        <\/label>\n                    <\/div>\n                    <div id=\"cardio-autre-panel\" class=\"qc-panel\">\n                        <input type=\"text\" name=\"cardio_nom\" class=\"qc-input\" placeholder=\"Nom du cardiologue\" style=\"width: 100%;\">\n                    <\/div>\n                <\/div>\n            <\/div>\n        <\/div>\n        \n        <div class=\"qc-main-grid\">\n            <div class=\"qc-section qc-section-atcd\">\n                <div class=\"qc-section-header\">\n                    <span class=\"qc-section-icon\">\ud83d\udea8<\/span>\n                    <h2 class=\"qc-section-title\">Ant\u00e9c\u00e9dents<\/h2>\n                <\/div>\n                <div class=\"qc-question\">\n                    <div class=\"qc-question-text\">\n                        <span class=\"qc-q-number\">1<\/span>\n                        <span>ATCD Cardiovasculaires ?<\/span>\n                    <\/div>\n                    <div class=\"qc-radio-group\">\n                        <label class=\"qc-radio-item\">\n                            <input type=\"radio\" name=\"q1_atcd\" value=\"NON\" id=\"q1-non\" class=\"qc-radio\" required>\n                            <span class=\"qc-radio-label\">NON<\/span>\n                        <\/label>\n                        <label class=\"qc-radio-item\">\n                            <input type=\"radio\" name=\"q1_atcd\" value=\"OUI\" id=\"q1-oui\" class=\"qc-radio\">\n                            <span class=\"qc-radio-label\">OUI<\/span>\n                        <\/label>\n                    <\/div>\n                    <div id=\"q1-panel\" class=\"qc-panel\">\n                        <div class=\"qc-panel-title\">Cocher ce qui s'applique :<\/div>\n                        <div class=\"qc-checkbox-list\">\n                            <label class=\"qc-checkbox-item\">\n                                <input type=\"checkbox\" name=\"atcd_idm\" value=\"IDM\"> IDM (infarctus)\n                            <\/label>\n                            <label class=\"qc-checkbox-item\">\n                                <input type=\"checkbox\" name=\"atcd_avc\" value=\"AVC\"> AVC\n                            <\/label>\n                            <label class=\"qc-checkbox-item\">\n                                <input type=\"checkbox\" name=\"atcd_stents\" value=\"Stents\"> Stents coronariens\n                            <\/label>\n                            <label class=\"qc-checkbox-item\">\n                                <input type=\"checkbox\" name=\"atcd_pontage\" value=\"Pontage\"> Pontage\n                            <\/label>\n                            <label class=\"qc-checkbox-item\">\n                                <input type=\"checkbox\" name=\"atcd_valve\" value=\"Valve\"> Op\u00e9ration valve\n                            <\/label>\n                            <label class=\"qc-checkbox-item\">\n                                <input type=\"checkbox\" name=\"atcd_arythmie\" value=\"Arythmie\"> Arythmie\/FA\n                            <\/label>\n                            <label class=\"qc-checkbox-item\">\n                                <input type=\"checkbox\" name=\"atcd_autre_check\" value=\"Autre\"> Autre : \n                                <input type=\"text\" name=\"atcd_autre_text\" class=\"qc-input-inline\" placeholder=\"Pr\u00e9ciser\">\n                            <\/label>\n                        <\/div>\n                    <\/div>\n                <\/div>\n            <\/div>\n            \n            <div class=\"qc-section qc-section-symptomes\">\n                <div class=\"qc-section-header\">\n                    <span class=\"qc-section-icon\">\u26a0\ufe0f<\/span>\n                    <h2 class=\"qc-section-title\">Sympt\u00f4mes<\/h2>\n                <\/div>\n                <div class=\"qc-question\">\n                    <div class=\"qc-question-text\">\n                        <span class=\"qc-q-number\">2<\/span>\n                        <span>Douleur thoracique ?<\/span>\n                    <\/div>\n                    <div class=\"qc-radio-group\">\n                        <label class=\"qc-radio-item\">\n                            <input type=\"radio\" name=\"q2_dt\" value=\"NON\" id=\"q2-non\" class=\"qc-radio\" required>\n                            <span class=\"qc-radio-label\">NON<\/span>\n                        <\/label>\n                        <label class=\"qc-radio-item\">\n                            <input type=\"radio\" name=\"q2_dt\" value=\"OUI\" id=\"q2-oui\" class=\"qc-radio\">\n                            <span class=\"qc-radio-label\">OUI<\/span>\n                        <\/label>\n                    <\/div>\n                <\/div>\n                <div class=\"qc-question\">\n                    <div class=\"qc-question-text\">\n                        <span class=\"qc-q-number\">3<\/span>\n                        <span>Essoufflement ?<\/span>\n                    <\/div>\n                    <div class=\"qc-radio-group\">\n                        <label class=\"qc-radio-item\">\n                            <input type=\"radio\" name=\"q3_esso\" value=\"NON\" id=\"q3-non\" class=\"qc-radio\" required>\n                            <span class=\"qc-radio-label\">NON<\/span>\n                        <\/label>\n                        <label class=\"qc-radio-item\">\n                            <input type=\"radio\" name=\"q3_esso\" value=\"OUI\" id=\"q3-oui\" class=\"qc-radio\">\n                            <span class=\"qc-radio-label\">OUI<\/span>\n                        <\/label>\n                    <\/div>\n                <\/div>\n                <div class=\"qc-question\">\n                    <div class=\"qc-question-text\">\n                        <span class=\"qc-q-number\">4<\/span>\n                        <span>Claudication (douleur mollet) ?<\/span>\n                    <\/div>\n                    <div class=\"qc-radio-group\">\n                        <label class=\"qc-radio-item\">\n                            <input type=\"radio\" name=\"q4_claud\" value=\"NON\" id=\"q4-non\" class=\"qc-radio\" required>\n                            <span class=\"qc-radio-label\">NON<\/span>\n                        <\/label>\n                        <label class=\"qc-radio-item\">\n                            <input type=\"radio\" name=\"q4_claud\" value=\"OUI\" id=\"q4-oui\" class=\"qc-radio\">\n                            <span class=\"qc-radio-label\">OUI<\/span>\n                        <\/label>\n                    <\/div>\n                <\/div>\n            <\/div>\n            \n            <div class=\"qc-section qc-section-fdr\">\n                <div class=\"qc-section-header\">\n                    <span class=\"qc-section-icon\">\ud83d\udcca<\/span>\n                    <h2 class=\"qc-section-title\">Facteurs Risque<\/h2>\n                <\/div>\n                <div class=\"qc-question\">\n                    <div class=\"qc-question-text\">\n                        <span class=\"qc-q-number\">5<\/span>\n                        <span>Diab\u00e8te ?<\/span>\n                    <\/div>\n                    <div class=\"qc-radio-group\">\n                        <label class=\"qc-radio-item\">\n                            <input type=\"radio\" name=\"q5_diab\" value=\"NON\" id=\"q5-non\" class=\"qc-radio\" required>\n                            <span class=\"qc-radio-label\">NON<\/span>\n                        <\/label>\n                        <label class=\"qc-radio-item\">\n                            <input type=\"radio\" name=\"q5_diab\" value=\"OUI\" id=\"q5-oui\" class=\"qc-radio\">\n                            <span class=\"qc-radio-label\">OUI<\/span>\n                        <\/label>\n                    <\/div>\n                <\/div>\n                <div class=\"qc-question\">\n                    <div class=\"qc-question-text\">\n                        <span class=\"qc-q-number\">6<\/span>\n                        <span>HTA ?<\/span>\n                    <\/div>\n                    <div class=\"qc-radio-group\">\n                        <label class=\"qc-radio-item\">\n                            <input type=\"radio\" name=\"q6_hta\" value=\"NON\" id=\"q6-non\" class=\"qc-radio\" required>\n                            <span class=\"qc-radio-label\">NON<\/span>\n                        <\/label>\n                        <label class=\"qc-radio-item\">\n                            <input type=\"radio\" name=\"q6_hta\" value=\"OUI\" id=\"q6-oui\" class=\"qc-radio\">\n                            <span class=\"qc-radio-label\">OUI<\/span>\n                        <\/label>\n                    <\/div>\n                <\/div>\n                <div class=\"qc-question\">\n                    <div class=\"qc-question-text\">\n                        <span class=\"qc-q-number\">7<\/span>\n                        <span>Tabac actuel ?<\/span>\n                    <\/div>\n                    <div class=\"qc-radio-group\">\n                        <label class=\"qc-radio-item\">\n                            <input type=\"radio\" name=\"q7_tabac\" value=\"NON\" id=\"q7-non\" class=\"qc-radio\" required>\n                            <span class=\"qc-radio-label\">NON<\/span>\n                        <\/label>\n                        <label class=\"qc-radio-item\">\n                            <input type=\"radio\" name=\"q7_tabac\" value=\"OUI\" id=\"q7-oui\" class=\"qc-radio\">\n                            <span class=\"qc-radio-label\">OUI<\/span>\n                        <\/label>\n                    <\/div>\n                    <div id=\"q7-panel\" class=\"qc-panel\">\n                        <div class=\"qc-panel-title\">Profil tabagique :<\/div>\n                        <div class=\"qc-tabac-profiles\">\n                            <label class=\"qc-profile-item\">\n                                <input type=\"radio\" name=\"tabac_profil\" value=\"leger\" id=\"tabac-leger\">\n                                <div class=\"qc-profile-box\">\n                                    <div class=\"qc-profile-label\">L\u00e9ger<\/div>\n                                    <div class=\"qc-profile-detail\">10 cig\/j \u00d7 5 ans<\/div>\n                                    <div class=\"qc-profile-pa\">2.5 PA<\/div>\n                                <\/div>\n                            <\/label>\n                            <label class=\"qc-profile-item\">\n                                <input type=\"radio\" name=\"tabac_profil\" value=\"moyen\" id=\"tabac-moyen\">\n                                <div class=\"qc-profile-box\">\n                                    <div class=\"qc-profile-label\">Moyen<\/div>\n                                    <div class=\"qc-profile-detail\">20 cig\/j \u00d7 10 ans<\/div>\n                                    <div class=\"qc-profile-pa\">10 PA<\/div>\n                                <\/div>\n                            <\/label>\n                            <label class=\"qc-profile-item\">\n                                <input type=\"radio\" name=\"tabac_profil\" value=\"fort\" id=\"tabac-fort\">\n                                <div class=\"qc-profile-box\">\n                                    <div class=\"qc-profile-label\">Fort<\/div>\n                                    <div class=\"qc-profile-detail\">30 cig\/j \u00d7 20 ans<\/div>\n                                    <div class=\"qc-profile-pa\">30 PA<\/div>\n                                <\/div>\n                            <\/label>\n                            <label class=\"qc-profile-item\">\n                                <input type=\"radio\" name=\"tabac_profil\" value=\"perso\" id=\"tabac-perso\" checked>\n                                <div class=\"qc-profile-box\">\n                                    <div class=\"qc-profile-label\">Personnalis\u00e9<\/div>\n                                <\/div>\n                            <\/label>\n                        <\/div>\n                        <div id=\"tabac-perso-panel\" class=\"qc-tabac-perso\">\n                            <div class=\"qc-panel-grid\">\n                                <input type=\"number\" name=\"tabac_cig\" id=\"tabac-cig\" class=\"qc-input\" placeholder=\"Cig\/jour\" min=\"0\">\n                                <input type=\"number\" name=\"tabac_annees\" id=\"tabac-annees\" class=\"qc-input\" placeholder=\"Ann\u00e9es\" min=\"0\">\n                            <\/div>\n                            <div id=\"pa-result\" class=\"qc-pa-result\">\n                                \ud83d\udcca <span id=\"pa-value\">0<\/span> PA\n                            <\/div>\n                        <\/div>\n                    <\/div>\n                <\/div>\n                <div class=\"qc-question\">\n                    <div class=\"qc-question-text\">\n                        <span class=\"qc-q-number\">8<\/span>\n                        <span>Cholest\u00e9rol ?<\/span>\n                    <\/div>\n                    <div class=\"qc-radio-group\">\n                        <label class=\"qc-radio-item\">\n                            <input type=\"radio\" name=\"q8_chol\" value=\"NON\" id=\"q8-non\" class=\"qc-radio\" required>\n                            <span class=\"qc-radio-label\">NON<\/span>\n                        <\/label>\n                        <label class=\"qc-radio-item\">\n                            <input type=\"radio\" name=\"q8_chol\" value=\"OUI\" id=\"q8-oui\" class=\"qc-radio\">\n                            <span class=\"qc-radio-label\">OUI<\/span>\n                        <\/label>\n                    <\/div>\n                <\/div>\n            <\/div>\n        <\/div>\n        \n        <div class=\"qc-actions\">\n            <div class=\"qc-buttons\">\n                <button type=\"submit\" id=\"qc-submit\" class=\"qc-button\">\n                    \ud83d\ude80 Calculer et d\u00e9terminer le RDV\n                <\/button>\n                <button type=\"button\" id=\"qc-reset\" class=\"qc-button qc-button-reset\">\n                    \ud83d\udd04 Reset\n                <\/button>\n            <\/div>\n            <div id=\"qc-alert\" class=\"qc-alert\"><\/div>\n        <\/div>\n    <\/form>\n    <\/div>\n    \n    <div id=\"qc-result\" class=\"qc-result\">\n        <div class=\"qc-result-content\">\n            <div class=\"qc-result-grid\">\n                <div class=\"qc-rdv-box\">\n                    <div class=\"qc-rdv-label\">\u23f0 TYPE RDV DOCTOLIB<\/div>\n                    <div id=\"qc-rdv-value\" class=\"qc-rdv-value\"><\/div>\n                <\/div>\n                \n                <div class=\"qc-notes-container\">\n                    <div class=\"qc-notes-header\">\n                        <h3 class=\"qc-notes-title\">\ud83d\udccb Notes Doctolib<\/h3>\n                        <button type=\"button\" id=\"qc-copy\" class=\"qc-copy-btn\">\ud83d\udccb Copier<\/button>\n                    <\/div>\n                    <pre id=\"qc-notes\" class=\"qc-notes\"><\/pre>\n                <\/div>\n                \n                <div class=\"qc-result-actions\">\n                    <button type=\"button\" id=\"qc-new-qualif\" class=\"qc-new-qualif-btn\">\n                        \ud83d\udd04 Nouvelle Qualification\n                    <\/button>\n                <\/div>\n            <\/div>\n        <\/div>\n    <\/div>\n<\/div>\n\n<script>\n(function() {\n    'use strict';\n    const $ = jQuery;\n    const config = {\n        ajaxUrl: '<?php echo $ajax_url; ?>',\n        nonce: '<?php echo $nonce; ?>'\n    };\n    \n    const $form = $('#qc-form');\n    const $formContainer = $('.qc-form-container');\n    const $result = $('#qc-result');\n    const $notes = $('#qc-notes');\n    const $rdvValue = $('#qc-rdv-value');\n    const $alert = $('#qc-alert');\n    const $submitBtn = $('#qc-submit');\n    \n    \/\/ ============================================\n    \/\/ GESTION DU ZOOM - 70% PAR D\u00c9FAUT\n    \/\/ ============================================\n    const STORAGE_KEY = 'qualif_cardio_zoom';\n    const minZoom = 0.5;\n    const maxZoom = 1.5;\n    const zoomStep = 0.1;\n    \n    let currentZoom;\n    let defaultZoom;\n    \n    \/\/ Zoom par d\u00e9faut \u00e0 70% pour tous les \u00e9crans\n    function getDefaultZoom() {\n        return 0.7;\n    }\n    \n    function loadZoom() {\n        const saved = localStorage.getItem(STORAGE_KEY);\n        if (saved) {\n            currentZoom = parseFloat(saved);\n            console.log('\ud83d\udcca Zoom charg\u00e9 depuis localStorage:', currentZoom);\n        } else {\n            defaultZoom = getDefaultZoom();\n            currentZoom = defaultZoom;\n            console.log('\ud83d\udcca Zoom par d\u00e9faut \u00e0 70%:', currentZoom);\n        }\n        updateZoom(currentZoom, false);\n    }\n    \n    function saveZoom(zoom) {\n        localStorage.setItem(STORAGE_KEY, zoom);\n        console.log('\ud83d\udcbe Zoom sauvegard\u00e9:', zoom);\n    }\n    \n    function updateZoom(newZoom, save = true) {\n        if (newZoom < minZoom) newZoom = minZoom;\n        if (newZoom > maxZoom) newZoom = maxZoom;\n        currentZoom = newZoom;\n        $('.qc-wrapper').css('zoom', currentZoom);\n        $('#qc-zoom-display').text(Math.round(currentZoom * 100) + '%');\n        if (save) {\n            saveZoom(currentZoom);\n        }\n    }\n    \n    function resetZoom() {\n        const newDefault = getDefaultZoom();\n        updateZoom(newDefault);\n        console.log('\ud83d\udd04 Zoom r\u00e9initialis\u00e9 \u00e0 70%');\n    }\n    \n    $('#qc-zoom-plus').on('click', function() {\n        updateZoom(currentZoom + zoomStep);\n    });\n    \n    $('#qc-zoom-minus').on('click', function() {\n        updateZoom(currentZoom - zoomStep);\n    });\n    \n    $('#qc-zoom-display').on('dblclick', function() {\n        resetZoom();\n    });\n    \n    $(document).on('keydown', function(e) {\n        if (e.ctrlKey || e.metaKey) {\n            if (e.key === '+' || e.key === '=') {\n                e.preventDefault();\n                updateZoom(currentZoom + zoomStep);\n            } else if (e.key === '-' || e.key === '_') {\n                e.preventDefault();\n                updateZoom(currentZoom - zoomStep);\n            }\n        }\n    });\n    \n    loadZoom();\n    \n    \/\/ ============================================\n    \/\/ INTERACTIONS FORMULAIRE\n    \/\/ ============================================\n    $('input[name=\"adresseur_type\"]').on('change', function() {\n        if ($(this).val() === 'Autre') {\n            $('#adresseur-autre-field').slideDown(200);\n        } else {\n            $('#adresseur-autre-field').slideUp(200);\n            $('input[name=\"adresseur_nom\"]').val('');\n        }\n    });\n    \n    $('input[name=\"suivi_cardio\"]').on('change', function() {\n        if ($(this).val() === 'OUI') {\n            $('#cardio-field').slideDown(200);\n        } else {\n            $('#cardio-field').slideUp(200);\n            $('input[name=\"cardio_type\"]').prop('checked', false);\n            $('#cardio-autre-panel').hide();\n            $('input[name=\"cardio_nom\"]').val('');\n        }\n    });\n    \n    $('input[name=\"cardio_type\"]').on('change', function() {\n        if ($(this).val() === 'Autre') {\n            $('#cardio-autre-panel').slideDown(200);\n        } else {\n            $('#cardio-autre-panel').slideUp(200);\n            $('input[name=\"cardio_nom\"]').val('');\n        }\n    });\n    \n    $('#q1-oui').on('change', function() { $('#q1-panel').slideDown(200); });\n    $('#q1-non').on('change', function() { \n        $('#q1-panel').slideUp(200);\n        $('#q1-panel input[type=\"checkbox\"]').prop('checked', false);\n        $('input[name=\"atcd_autre_text\"]').val('');\n    });\n    \n    $('#q7-oui').on('change', function() { $('#q7-panel').slideDown(200); });\n    $('#q7-non').on('change', function() { \n        $('#q7-panel').slideUp(200);\n        $('input[name=\"tabac_profil\"]').prop('checked', false);\n        $('#tabac-perso').prop('checked', true);\n        $('#tabac-cig, #tabac-annees').val('');\n        $('#pa-result').hide();\n    });\n    \n    const tabacProfiles = {\n        leger: { cig: 10, ans: 5, pa: 2.5 },\n        moyen: { cig: 20, ans: 10, pa: 10 },\n        fort: { cig: 30, ans: 20, pa: 30 }\n    };\n    \n    $('input[name=\"tabac_profil\"]').on('change', function() {\n        const profil = $(this).val();\n        if (profil !== 'perso' && tabacProfiles[profil]) {\n            const data = tabacProfiles[profil];\n            $('#tabac-cig').val(data.cig);\n            $('#tabac-annees').val(data.ans);\n            $('#pa-value').text(data.pa);\n            $('#pa-result').slideDown(200);\n        }\n    });\n    \n    function calcPA() {\n        const cig = parseFloat($('#tabac-cig').val()) || 0;\n        const ans = parseFloat($('#tabac-annees').val()) || 0;\n        if (cig > 0 && ans > 0) {\n            const pa = ((cig \/ 20) * ans).toFixed(1);\n            $('#pa-value').text(pa);\n            $('#pa-result').slideDown(200);\n            return pa;\n        } else {\n            $('#pa-result').slideUp(200);\n            return null;\n        }\n    }\n    \n    $('#tabac-cig, #tabac-annees').on('input', function() {\n        $('#tabac-perso').prop('checked', true);\n        calcPA();\n    });\n    \n    $('input[type=\"radio\"]').on('change', function() {\n        const name = $(this).attr('name');\n        $('input[name=\"' + name + '\"]').closest('.qc-radio-item').removeClass('selected');\n        $(this).closest('.qc-radio-item').addClass('selected');\n    });\n    \n    $('input[type=\"radio\"]:checked').each(function() {\n        $(this).closest('.qc-radio-item').addClass('selected');\n    });\n    \n    const utils = {\n        showAlert: function(msg, type) {\n            $alert.removeClass('qc-alert-success qc-alert-error').addClass('qc-alert-' + type).text(msg).fadeIn();\n            setTimeout(() => $alert.fadeOut(), 5000);\n        }\n    };\n    \n    \/\/ ============================================\n    \/\/ LOGIQUE M\u00c9TIER - AVEC CORRECTIONS v5.3\n    \/\/ ============================================\n    const business = {\n        \/**\n         * Compte les facteurs de risque cardiovasculaire\n         * Guidelines ESC 2021 : \u00c2ge (H>55, F>60), Diab\u00e8te, HTA, Tabac, Cholest\u00e9rol\n         * CORRECTION v5.3 : Tabac compt\u00e9 uniquement si PA >= 1\n         *\/\n        countFacteurs: function(data) {\n            let count = 0, list = [];\n            \n            \/\/ Diab\u00e8te\n            if (data.q5_diab === 'OUI') { \n                count++; \n                list.push('Diab\u00e8te'); \n            }\n            \n            \/\/ HTA\n            if (data.q6_hta === 'OUI') { \n                count++; \n                list.push('HTA'); \n            }\n            \n            \/\/ Tabac : CORRECTION - Uniquement si PA >= 1\n            if (data.q7_tabac === 'OUI' && data.tabacPA && parseFloat(data.tabacPA) >= 1) {\n                count++;\n                list.push('Tabac actuel (' + data.tabacPA + ' PA)');\n            }\n            \n            \/\/ Cholest\u00e9rol\n            if (data.q8_chol === 'OUI') { \n                count++; \n                list.push('Cholest\u00e9rol'); \n            }\n            \n            \/\/ \u00c2ge (Guidelines ESC : H>55ans, F>60ans)\n            const age = parseInt(data.age);\n            const sexe = data.sexe;\n            if ((sexe === 'Homme' && age > 55) || (sexe === 'Femme' && age > 60)) {\n                count++; \n                list.push('\u00c2ge (' + age + ' ans)');\n            }\n            \n            return { count: count, list: list };\n        },\n        \n        \/**\n         * D\u00e9termine le type de RDV selon protocole cabinet\n         * PRIORITAIRE si :\n         * - ATCD cardiovasculaire (IDM, AVC, stents, etc.)\n         * - Douleur thoracique (sympt\u00f4me urgent)\n         * - >= 3 facteurs de risque\n         * - >= 2 facteurs de risque + sympt\u00f4mes (essoufflement ou claudication)\n         *\/\n        determineRDV: function(data, facteurs) {\n            \/\/ ATCD cardio = PRIORITAIRE\n            if (data.q1_atcd === 'OUI') {\n                return '1\u00e8re consultation prioritaire';\n            }\n            \n            \/\/ Douleur thoracique = PRIORITAIRE (urgence potentielle)\n            if (data.q2_dt === 'OUI') {\n                return '1\u00e8re consultation prioritaire';\n            }\n            \n            \/\/ >= 3 FDR = PRIORITAIRE\n            if (facteurs.count >= 3) {\n                return '1\u00e8re consultation prioritaire';\n            }\n            \n            \/\/ >= 2 FDR + sympt\u00f4mes = PRIORITAIRE\n            const hasSymptom = (data.q3_esso === 'OUI' || data.q4_claud === 'OUI');\n            if (facteurs.count >= 2 && hasSymptom) {\n                return '1\u00e8re consultation prioritaire';\n            }\n            \n            \/\/ Sinon = Risque faible\n            return '1\u00e8re consultation risque faible';\n        },\n        \n        \/**\n         * G\u00e9n\u00e8re les notes Doctolib format\u00e9es\n         *\/\n        generateNotes: function(data, facteurs) {\n            let notes = '';\n            \n            \/\/ En-t\u00eate patient\n            notes += 'PATIENT : ' + data.age + ' ans - ' + data.sexe + ' - IMC: ' + data.imc;\n            notes += ' (' + data.taille + 'cm, ' + data.poids + 'kg)\\n';\n            notes += 'M\u00e9decin adresseur : ' + data.medecin_adresseur + '\\n';\n            notes += 'Commune de R\u00e9sidence : ' + data.commune + '\\n';\n            notes += 'Suivi cardiologue : ' + data.suivi_cardio;\n            if (data.suivi_cardio === 'OUI' && data.nom_cardiologue) {\n                notes += ' (' + data.nom_cardiologue + ')';\n            }\n            notes += '\\n\\n';\n            \n            \/\/ Ant\u00e9c\u00e9dents\n            notes += 'Ant\u00e9c\u00e9dents : ';\n            if (data.q1_atcd === 'OUI') {\n                notes += 'OUI';\n                if (data.q1_atcd_details) {\n                    notes += '\\n  ' + data.q1_atcd_details;\n                }\n            } else {\n                notes += 'NON';\n            }\n            notes += '\\n\\n';\n            \n            \/\/ Sympt\u00f4mes\n            notes += 'Sympt\u00f4mes : ';\n            let symptoms = [];\n            if (data.q2_dt === 'OUI') symptoms.push('Douleur thoracique (\u2192 RDV PRIORITAIRE)');\n            if (data.q3_esso === 'OUI') symptoms.push('Essoufflement');\n            if (data.q4_claud === 'OUI') symptoms.push('Claudication');\n            notes += symptoms.length > 0 ? symptoms.join(', ') : 'Aucun';\n            notes += '\\n\\n';\n            \n            \/\/ Facteurs de risque\n            notes += 'Facteurs de risque : (' + facteurs.count + ')\\n';\n            if (facteurs.count > 0) {\n                facteurs.list.forEach(function(f) {\n                    notes += '  \u2022 ' + f + '\\n';\n                });\n            } else {\n                notes += '  \u2022 Aucun\\n';\n            }\n            \n            return notes;\n        }\n    };\n    \n    \/\/ ============================================\n    \/\/ SOUMISSION FORMULAIRE\n    \/\/ ============================================\n    $form.on('submit', function(e) {\n        e.preventDefault();\n        if ($form.data('submitting')) return false;\n        $form.data('submitting', true);\n        \n        if (!this.checkValidity()) {\n            utils.showAlert('\u26a0\ufe0f Veuillez remplir tous les champs obligatoires', 'error');\n            $form.data('submitting', false);\n            return;\n        }\n        \n        $submitBtn.prop('disabled', true).text('\u23f3 Calcul en cours...');\n        \n        \/\/ Collecte m\u00e9decin adresseur\n        let medecinAdresseur = $('input[name=\"adresseur_type\"]:checked').val();\n        if (medecinAdresseur === 'Autre') {\n            const nomAutre = $('input[name=\"adresseur_nom\"]').val().trim();\n            medecinAdresseur = nomAutre ? nomAutre : 'Autre (non pr\u00e9cis\u00e9)';\n        }\n        \n        \/\/ Collecte ATCD d\u00e9tails\n        let atcdDetails = '';\n        if ($('input[name=\"q1_atcd\"]:checked').val() === 'OUI') {\n            let atcdList = [];\n            $('#q1-panel input[type=\"checkbox\"]:checked').each(function() {\n                const val = $(this).val();\n                if ($(this).attr('name') === 'atcd_autre_check') {\n                    const autreText = $('input[name=\"atcd_autre_text\"]').val().trim();\n                    if (autreText) atcdList.push('Autre : ' + autreText);\n                } else {\n                    atcdList.push(val);\n                }\n            });\n            atcdDetails = atcdList.length > 0 ? atcdList.join(', ') : '';\n        }\n        \n        \/\/ Collecte cardiologue\n        let nomCardio = '';\n        if ($('input[name=\"suivi_cardio\"]:checked').val() === 'OUI') {\n            const cardioType = $('input[name=\"cardio_type\"]:checked').val();\n            if (cardioType === 'Cabinet') {\n                nomCardio = 'Cardiologue du cabinet';\n            } else if (cardioType === 'Autre') {\n                const nomAutre = $('input[name=\"cardio_nom\"]').val().trim();\n                nomCardio = nomAutre ? nomAutre : 'Autre (non pr\u00e9cis\u00e9)';\n            }\n        }\n        \n        \/\/ Collecte donn\u00e9es tabac\n        let tabacCig = null, tabacAnnees = null, tabacPA = null;\n        if ($('input[name=\"q7_tabac\"]:checked').val() === 'OUI') {\n            const cig = parseFloat($('#tabac-cig').val()) || 0;\n            const ans = parseFloat($('#tabac-annees').val()) || 0;\n            if (cig > 0 && ans > 0) {\n                tabacCig = cig;\n                tabacAnnees = ans;\n                tabacPA = ((cig \/ 20) * ans).toFixed(1);\n            }\n        }\n        \n        \/\/ Construction objet donn\u00e9es\n        const formData = {\n            age: $('input[name=\"age\"]').val(),\n            sexe: $('input[name=\"sexe\"]:checked').val(),\n            taille: $('input[name=\"taille\"]').val(),\n            poids: $('input[name=\"poids\"]').val(),\n            imc: (parseFloat($('input[name=\"poids\"]').val()) \/ Math.pow(parseFloat($('input[name=\"taille\"]').val()) \/ 100, 2)).toFixed(2),\n            medecin_adresseur: medecinAdresseur,\n            commune: $('input[name=\"commune\"]').val(),\n            suivi_cardio: $('input[name=\"suivi_cardio\"]:checked').val(),\n            nom_cardiologue: nomCardio,\n            q1_atcd: $('input[name=\"q1_atcd\"]:checked').val(),\n            q1_atcd_details: atcdDetails,\n            q2_dt: $('input[name=\"q2_dt\"]:checked').val(),\n            q3_esso: $('input[name=\"q3_esso\"]:checked').val(),\n            q4_claud: $('input[name=\"q4_claud\"]:checked').val(),\n            q5_diab: $('input[name=\"q5_diab\"]:checked').val(),\n            q6_hta: $('input[name=\"q6_hta\"]:checked').val(),\n            q7_tabac: $('input[name=\"q7_tabac\"]:checked').val(),\n            q7_tabac_cigarettes: tabacCig,\n            q7_tabac_annees: tabacAnnees,\n            q7_tabac_pa: tabacPA,\n            q8_chol: $('input[name=\"q8_chol\"]:checked').val(),\n            tabacPA: tabacPA\n        };\n        \n        \/\/ Calcul qualification\n        const facteurs = business.countFacteurs(formData);\n        const typeRDV = business.determineRDV(formData, facteurs);\n        const notesDoctolib = business.generateNotes(formData, facteurs);\n        \n        \/\/ Affichage r\u00e9sultat\n        $rdvValue.text(typeRDV);\n        $notes.text(notesDoctolib);\n        \n        $formContainer.fadeOut(300, function() {\n            $result.fadeIn(400);\n            $('body').css('overflow', 'hidden');\n        });\n        \n        \/\/ Envoi AJAX\n        $.ajax({\n            url: config.ajaxUrl,\n            type: 'POST',\n            data: {\n                action: 'qc_submit',\n                nonce: config.nonce,\n                website: $('input[name=\"website\"]').val(),\n                data: JSON.stringify({\n                    age: formData.age,\n                    sexe: formData.sexe,\n                    taille: formData.taille,\n                    poids: formData.poids,\n                    imc: formData.imc,\n                    medecin_adresseur: formData.medecin_adresseur,\n                    commune: formData.commune,\n                    suivi_cardio: formData.suivi_cardio,\n                    nom_cardiologue: formData.nom_cardiologue,\n                    q1_atcd: formData.q1_atcd,\n                    q1_atcd_details: formData.q1_atcd_details,\n                    q2_dt: formData.q2_dt,\n                    q3_esso: formData.q3_esso,\n                    q4_claud: formData.q4_claud,\n                    q5_diab: formData.q5_diab,\n                    q6_hta: formData.q6_hta,\n                    q7_tabac: formData.q7_tabac,\n                    q7_tabac_cigarettes: formData.q7_tabac_cigarettes,\n                    q7_tabac_annees: formData.q7_tabac_annees,\n                    q7_tabac_pa: formData.q7_tabac_pa,\n                    q8_chol: formData.q8_chol,\n                    nb_facteurs: facteurs.count,\n                    type_rdv: typeRDV,\n                    notes_doctolib: notesDoctolib\n                })\n            },\n            success: function(response) {\n                if (response.success) {\n                    utils.showAlert('\u2705 ' + response.data.message, 'success');\n                } else {\n                    utils.showAlert('\u26a0\ufe0f ' + response.data.message, 'error');\n                }\n            },\n            error: function() {\n                utils.showAlert('\u26a0\ufe0f Erreur r\u00e9seau (notes affich\u00e9es)', 'error');\n            },\n            complete: function() {\n                $submitBtn.prop('disabled', false).text('\ud83d\ude80 Calculer et d\u00e9terminer le RDV');\n                $form.data('submitting', false);\n            }\n        });\n    });\n    \n    \/\/ ============================================\n    \/\/ BOUTONS RESET \/ NOUVELLE QUALIF \/ COPIE\n    \/\/ ============================================\n    $('#qc-reset').on('click', function() {\n        if (confirm('R\u00e9initialiser le formulaire ?')) {\n            $form[0].reset();\n            $result.fadeOut();\n            $formContainer.fadeIn();\n            $alert.hide();\n            $('.qc-panel').hide();\n            $('#cardio-field, #adresseur-autre-field').hide();\n            $('#pa-result').hide();\n            $('.qc-radio-item').removeClass('selected');\n            $('body').css('overflow', '');\n            $('html, body').animate({ scrollTop: 0 }, 500);\n            utils.showAlert('\u2705 Pr\u00eat pour nouvelle qualification', 'success');\n        }\n    });\n    \n    $('#qc-new-qualif').on('click', function() {\n        $result.fadeOut(300, function() {\n            $form[0].reset();\n            $('.qc-panel').hide();\n            $('#cardio-field, #adresseur-autre-field').hide();\n            $('#pa-result').hide();\n            $('.qc-radio-item').removeClass('selected');\n            $alert.hide();\n            $formContainer.fadeIn(400);\n            $('body').css('overflow', '');\n            $('html, body').animate({ scrollTop: 0 }, 500);\n        });\n    });\n    \n    $('#qc-copy').on('click', function() {\n        const text = $notes.text();\n        if (navigator.clipboard) {\n            navigator.clipboard.writeText(text).then(function() {\n                $('#qc-copy').text('\u2713 Copi\u00e9 !');\n                setTimeout(function() { $('#qc-copy').text('\ud83d\udccb Copier'); }, 2500);\n            });\n        } else {\n            alert('Copie automatique non support\u00e9e');\n        }\n    });\n})();\n<\/script>\n        <?php\n        return ob_get_clean();\n    }\n}\n\nadd_shortcode('qualif_cardio', 'qc_shortcode');","tags":["qualif-cardio","formulaire"],"active":true,"modified":"2025-10-21 09:38:10","revision":"1"}]}