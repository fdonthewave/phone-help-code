{"generator":"Code Snippets v3.9.2","date_created":"2025-11-23 19:02","snippets":[{"id":11,"name":"Qualif Pneumo Audit","code":"\/**\n * \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n * QUALIF PNEUMO AUDIT - VERSION 1.0\n * \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n * \n * Outil de recherche et audit des qualifications pneumologie\n * Permet de retrouver les qualifications et croiser avec Callibri\n * \n * SHORTCODE : [pneumo_audit]\n * TABLE BDD : qualif_pneumo_amiotsimion\n * \n * \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n *\/\n\n\/\/ S\u00e9curit\u00e9 WordPress\nif (!defined('ABSPATH')) exit;\n\n\/\/ \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n\/\/ TRAITEMENT AJAX RECHERCHE\n\/\/ \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n\nadd_action('wp_ajax_pneumo_audit_search', 'qp_audit_search');\nadd_action('wp_ajax_nopriv_pneumo_audit_search', 'qp_audit_search');\n\nfunction qp_audit_search() {\n    global $wpdb;\n    \n    \/\/ V\u00e9rification nonce\n    if (!isset($_POST['nonce']) || !wp_verify_nonce($_POST['nonce'], 'pneumo_audit_nonce')) {\n        wp_send_json_error('S\u00e9curit\u00e9 : requ\u00eate invalide');\n    }\n    \n    $table_name = $wpdb->prefix . 'qualif_pneumo_amiotsimion';\n    \n    \/\/ V\u00e9rifier que la table existe\n    if ($wpdb->get_var(\"SHOW TABLES LIKE '$table_name'\") != $table_name) {\n        wp_send_json_error('Table non trouv\u00e9e. Aucune qualification enregistr\u00e9e.');\n    }\n    \n    $search_type = sanitize_text_field($_POST['search_type']);\n    $search_value = sanitize_text_field($_POST['search_value']);\n    \n    if (empty($search_value)) {\n        wp_send_json_error('Veuillez saisir un crit\u00e8re de recherche');\n    }\n    \n    \/\/ Construction de la requ\u00eate selon le type\n    switch ($search_type) {\n        case 'nom':\n            $results = $wpdb->get_results($wpdb->prepare(\n                \"SELECT * FROM $table_name WHERE nom LIKE %s ORDER BY timestamp DESC LIMIT 50\",\n                '%' . $wpdb->esc_like($search_value) . '%'\n            ));\n            break;\n            \n        case 'prenom':\n            $results = $wpdb->get_results($wpdb->prepare(\n                \"SELECT * FROM $table_name WHERE prenom LIKE %s ORDER BY timestamp DESC LIMIT 50\",\n                '%' . $wpdb->esc_like($search_value) . '%'\n            ));\n            break;\n            \n        case 'telephone':\n            \/\/ Nettoyer le num\u00e9ro (enlever espaces, points, tirets)\n            $clean_phone = preg_replace('\/[^0-9]\/', '', $search_value);\n            $results = $wpdb->get_results($wpdb->prepare(\n                \"SELECT * FROM $table_name WHERE REPLACE(REPLACE(REPLACE(telephone, ' ', ''), '.', ''), '-', '') LIKE %s ORDER BY timestamp DESC LIMIT 50\",\n                '%' . $wpdb->esc_like($clean_phone) . '%'\n            ));\n            break;\n            \n        case 'date':\n            $results = $wpdb->get_results($wpdb->prepare(\n                \"SELECT * FROM $table_name WHERE DATE(timestamp) = %s ORDER BY timestamp DESC\",\n                $search_value\n            ));\n            break;\n            \n        default:\n            wp_send_json_error('Type de recherche invalide');\n    }\n    \n    if (empty($results)) {\n        wp_send_json_error('Aucun r\u00e9sultat trouv\u00e9');\n    }\n    \n    wp_send_json_success($results);\n}\n\n\/\/ \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n\/\/ SHORTCODE INTERFACE AUDIT\n\/\/ \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n\nadd_shortcode('pneumo_audit', 'qp_audit_render');\n\nfunction qp_audit_render() {\n    $nonce = wp_create_nonce('pneumo_audit_nonce');\n    \n    ob_start();\n    ?>\n    \n    <style>\n        \/* Zoom par d\u00e9faut *\/\n        body.audit-pneumo-page { zoom: 0.7; }\n        \n        .qpa-container {\n            max-width: 1200px;\n            margin: 0 auto;\n            background: white;\n            padding: 30px;\n            border-radius: 12px;\n            box-shadow: 0 4px 20px rgba(0,0,0,0.1);\n            font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, sans-serif;\n        }\n        \n        .qpa-header {\n            background: linear-gradient(135deg, #20B2AA 0%, #008B8B 100%);\n            color: white;\n            padding: 25px;\n            border-radius: 8px;\n            text-align: center;\n            margin-bottom: 30px;\n        }\n        \n        .qpa-header h2 {\n            margin: 0;\n            font-size: 28px;\n        }\n        \n        .qpa-header p {\n            margin: 8px 0 0 0;\n            opacity: 0.95;\n        }\n        \n        .qpa-search-box {\n            background: #f8fafc;\n            padding: 25px;\n            border-radius: 8px;\n            margin-bottom: 30px;\n            border: 2px solid #20B2AA;\n        }\n        \n        .qpa-search-title {\n            font-size: 18px;\n            font-weight: bold;\n            color: #1e293b;\n            margin-bottom: 20px;\n        }\n        \n        .qpa-search-row {\n            display: flex;\n            gap: 15px;\n            align-items: flex-end;\n        }\n        \n        .qpa-field {\n            flex: 1;\n        }\n        \n        .qpa-label {\n            display: block;\n            font-weight: 600;\n            color: #334155;\n            margin-bottom: 8px;\n            font-size: 14px;\n        }\n        \n        .qpa-input, .qpa-select {\n            width: 100%;\n            padding: 12px;\n            border: 2px solid #cbd5e1;\n            border-radius: 6px;\n            font-size: 15px;\n        }\n        \n        .qpa-input:focus, .qpa-select:focus {\n            outline: none;\n            border-color: #20B2AA;\n        }\n        \n        .qpa-search-btn {\n            padding: 12px 30px;\n            background: linear-gradient(135deg, #20B2AA 0%, #008B8B 100%);\n            color: white;\n            border: none;\n            border-radius: 6px;\n            font-size: 16px;\n            font-weight: bold;\n            cursor: pointer;\n            transition: transform 0.2s;\n        }\n        \n        .qpa-search-btn:hover {\n            transform: translateY(-2px);\n        }\n        \n        .qpa-search-btn:disabled {\n            background: #94a3b8;\n            cursor: not-allowed;\n            transform: none;\n        }\n        \n        .qpa-loading {\n            display: none;\n            text-align: center;\n            padding: 40px;\n        }\n        \n        .qpa-loading.active {\n            display: block;\n        }\n        \n        .qpa-spinner {\n            border: 4px solid #f3f4f6;\n            border-top: 4px solid #20B2AA;\n            border-radius: 50%;\n            width: 50px;\n            height: 50px;\n            animation: qpa-spin 1s linear infinite;\n            margin: 0 auto 15px;\n        }\n        \n        @keyframes qpa-spin {\n            0% { transform: rotate(0deg); }\n            100% { transform: rotate(360deg); }\n        }\n        \n        .qpa-results {\n            display: none;\n        }\n        \n        .qpa-results.visible {\n            display: block;\n        }\n        \n        .qpa-results-header {\n            background: #e0f2f1;\n            padding: 15px 20px;\n            border-radius: 8px;\n            margin-bottom: 20px;\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n        }\n        \n        .qpa-results-count {\n            font-weight: bold;\n            color: #1e293b;\n            font-size: 16px;\n        }\n        \n        .qpa-result-card {\n            background: white;\n            border: 2px solid #cbd5e1;\n            border-radius: 8px;\n            padding: 20px;\n            margin-bottom: 15px;\n            transition: border-color 0.2s;\n        }\n        \n        .qpa-result-card:hover {\n            border-color: #20B2AA;\n        }\n        \n        .qpa-result-header {\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            margin-bottom: 15px;\n            padding-bottom: 15px;\n            border-bottom: 2px solid #e2e8f0;\n        }\n        \n        .qpa-result-title {\n            font-size: 20px;\n            font-weight: bold;\n            color: #1e293b;\n        }\n        \n        .qpa-result-date {\n            color: #64748b;\n            font-size: 14px;\n        }\n        \n        .qpa-result-grid {\n            display: grid;\n            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));\n            gap: 15px;\n            margin-bottom: 15px;\n        }\n        \n        .qpa-result-item {\n            background: #f8fafc;\n            padding: 12px;\n            border-radius: 6px;\n        }\n        \n        .qpa-result-label {\n            font-size: 12px;\n            color: #64748b;\n            text-transform: uppercase;\n            font-weight: 600;\n            margin-bottom: 4px;\n        }\n        \n        .qpa-result-value {\n            font-size: 15px;\n            color: #1e293b;\n            font-weight: 500;\n        }\n        \n        .qpa-notes-section {\n            background: #f1f5f9;\n            padding: 15px;\n            border-radius: 6px;\n            margin-top: 15px;\n        }\n        \n        .qpa-notes-title {\n            font-weight: bold;\n            color: #1e293b;\n            margin-bottom: 10px;\n        }\n        \n        .qpa-notes-content {\n            background: white;\n            padding: 15px;\n            border-radius: 4px;\n            border: 1px solid #cbd5e1;\n            font-family: 'Courier New', monospace;\n            font-size: 13px;\n            white-space: pre-wrap;\n            max-height: 300px;\n            overflow-y: auto;\n        }\n        \n        .qpa-actions {\n            display: flex;\n            gap: 10px;\n            margin-top: 15px;\n        }\n        \n        .qpa-btn {\n            padding: 10px 20px;\n            border: none;\n            border-radius: 6px;\n            font-weight: 600;\n            cursor: pointer;\n            transition: transform 0.2s;\n            text-decoration: none;\n            display: inline-block;\n        }\n        \n        .qpa-btn:hover {\n            transform: translateY(-2px);\n        }\n        \n        .qpa-btn-callibri {\n            background: #3b82f6;\n            color: white;\n        }\n        \n        .qpa-btn-copy {\n            background: #20B2AA;\n            color: white;\n        }\n        \n        .qpa-error {\n            background: #fee2e2;\n            border: 2px solid #ef4444;\n            padding: 20px;\n            border-radius: 8px;\n            color: #991b1b;\n            display: none;\n        }\n        \n        .qpa-error.visible {\n            display: block;\n        }\n        \n        .qpa-badge {\n            display: inline-block;\n            padding: 4px 12px;\n            border-radius: 12px;\n            font-size: 12px;\n            font-weight: 600;\n        }\n        \n        .qpa-badge-oui {\n            background: #dcfce7;\n            color: #166534;\n        }\n        \n        .qpa-badge-non {\n            background: #fee2e2;\n            color: #991b1b;\n        }\n    <\/style>\n    \n    <div class=\"qpa-container\">\n        <div class=\"qpa-header\">\n            <h2>\ud83d\udd0d Audit Qualifications Pneumologie<\/h2>\n            <p>Recherche et consultation des qualifications enregistr\u00e9es<\/p>\n        <\/div>\n        \n        <div class=\"qpa-search-box\">\n            <div class=\"qpa-search-title\">\ud83d\udccb Rechercher une qualification<\/div>\n            \n            <form id=\"audit-search-form\">\n                <div class=\"qpa-search-row\">\n                    <div class=\"qpa-field\">\n                        <label class=\"qpa-label\">Type de recherche<\/label>\n                        <select name=\"search_type\" id=\"search-type\" class=\"qpa-select\" required>\n                            <option value=\"nom\">Nom<\/option>\n                            <option value=\"prenom\">Pr\u00e9nom<\/option>\n                            <option value=\"telephone\">T\u00e9l\u00e9phone<\/option>\n                            <option value=\"date\">Date (AAAA-MM-JJ)<\/option>\n                        <\/select>\n                    <\/div>\n                    \n                    <div class=\"qpa-field\">\n                        <label class=\"qpa-label\">Valeur recherch\u00e9e<\/label>\n                        <input type=\"text\" name=\"search_value\" id=\"search-value\" class=\"qpa-input\" placeholder=\"Ex: Dupont, 0612345678, 2024-10-21\" required>\n                    <\/div>\n                    \n                    <button type=\"submit\" class=\"qpa-search-btn\">\n                        \ud83d\udd0d Rechercher\n                    <\/button>\n                <\/div>\n            <\/form>\n        <\/div>\n        \n        <div class=\"qpa-loading\" id=\"loading\">\n            <div class=\"qpa-spinner\"><\/div>\n            <p>Recherche en cours...<\/p>\n        <\/div>\n        \n        <div class=\"qpa-error\" id=\"error\"><\/div>\n        \n        <div class=\"qpa-results\" id=\"results\">\n            <div class=\"qpa-results-header\">\n                <div class=\"qpa-results-count\" id=\"results-count\"><\/div>\n            <\/div>\n            <div id=\"results-list\"><\/div>\n        <\/div>\n    <\/div>\n    \n    <script>\n    jQuery(document).ready(function($) {\n        \/\/ Appliquer le zoom\n        $('body').addClass('audit-pneumo-page');\n        \n        \/\/ Helper pour formater la date\n        function formatDate(timestamp) {\n            const date = new Date(timestamp);\n            return date.toLocaleDateString('fr-FR', { \n                year: 'numeric', \n                month: 'long', \n                day: 'numeric',\n                hour: '2-digit',\n                minute: '2-digit'\n            });\n        }\n        \n        \/\/ Helper pour g\u00e9n\u00e9rer URL Callibri\n        function getCallibriUrl(telephone, timestamp) {\n            const date = new Date(timestamp);\n            const day = String(date.getDate()).padStart(2, '0');\n            const month = String(date.getMonth() + 1).padStart(2, '0');\n            const year = date.getFullYear();\n            \n            \/\/ Nettoyer le t\u00e9l\u00e9phone\n            const cleanPhone = telephone.replace(\/[^0-9]\/g, '');\n            \n            return `https:\/\/app.callibri.io\/search?phone=${cleanPhone}&date_from=${day}.${month}.${year}&date_to=${day}.${month}.${year}`;\n        }\n        \n        \/\/ Afficher les r\u00e9sultats\n        function displayResults(data) {\n            let html = '';\n            \n            data.forEach(function(row) {\n                const callibriUrl = getCallibriUrl(row.telephone, row.timestamp);\n                \n                html += `\n                <div class=\"qpa-result-card\">\n                    <div class=\"qpa-result-header\">\n                        <div class=\"qpa-result-title\">\n                            ${row.prenom} ${row.nom}\n                        <\/div>\n                        <div class=\"qpa-result-date\">\n                            \ud83d\udcc5 ${formatDate(row.timestamp)}\n                        <\/div>\n                    <\/div>\n                    \n                    <div class=\"qpa-result-grid\">\n                        <div class=\"qpa-result-item\">\n                            <div class=\"qpa-result-label\">\ud83d\udcde T\u00e9l\u00e9phone<\/div>\n                            <div class=\"qpa-result-value\">${row.telephone}<\/div>\n                        <\/div>\n                        \n                        <div class=\"qpa-result-item\">\n                            <div class=\"qpa-result-label\">\ud83c\udf82 Age<\/div>\n                            <div class=\"qpa-result-value\">${row.age} ans<\/div>\n                        <\/div>\n                        \n                        <div class=\"qpa-result-item\">\n                            <div class=\"qpa-result-label\">\ud83d\udc68\u200d\u2695\ufe0f M\u00e9decin<\/div>\n                            <div class=\"qpa-result-value\">${row.medecin}<\/div>\n                        <\/div>\n                        \n                        <div class=\"qpa-result-item\">\n                            <div class=\"qpa-result-label\">\ud83d\udcc5 Type RDV<\/div>\n                            <div class=\"qpa-result-value\">${row.type_rdv}<\/div>\n                        <\/div>\n                    <\/div>\n                    \n                    <div class=\"qpa-result-grid\" style=\"margin-top: 15px;\">\n                        <div class=\"qpa-result-item\">\n                            <div class=\"qpa-result-label\">\ud83e\udec1 Toux<\/div>\n                            <div class=\"qpa-result-value\">\n                                <span class=\"qpa-badge qpa-badge-${row.toux}\">${row.toux.toUpperCase()}<\/span>\n                            <\/div>\n                        <\/div>\n                        \n                        <div class=\"qpa-result-item\">\n                            <div class=\"qpa-result-label\">\ud83d\udca7 Crachats<\/div>\n                            <div class=\"qpa-result-value\">\n                                <span class=\"qpa-badge qpa-badge-${row.crachats}\">${row.crachats.toUpperCase()}<\/span>\n                            <\/div>\n                        <\/div>\n                        \n                        <div class=\"qpa-result-item\">\n                            <div class=\"qpa-result-label\">\ud83d\udeac Fumeur<\/div>\n                            <div class=\"qpa-result-value\">\n                                <span class=\"qpa-badge qpa-badge-${row.fumeur}\">${row.fumeur.toUpperCase()}<\/span>\n                                ${row.fumeur === 'oui' && row.fumeur_pa ? ' - ' + row.fumeur_pa + ' PA' : ''}\n                            <\/div>\n                        <\/div>\n                    <\/div>\n                    \n                    <div class=\"qpa-notes-section\">\n                        <div class=\"qpa-notes-title\">\ud83d\udccb Notes Doctolib<\/div>\n                        <div class=\"qpa-notes-content\" id=\"notes-${row.id}\">${row.notes_doctolib}<\/div>\n                    <\/div>\n                    \n                    <div class=\"qpa-actions\">\n                        <a href=\"${callibriUrl}\" target=\"_blank\" class=\"qpa-btn qpa-btn-callibri\">\n                            \ud83d\udcde Ouvrir dans Callibri\n                        <\/a>\n                        <button onclick=\"copyNotes(${row.id})\" class=\"qpa-btn qpa-btn-copy\">\n                            \ud83d\udccb Copier les notes\n                        <\/button>\n                    <\/div>\n                <\/div>\n                `;\n            });\n            \n            $('#results-list').html(html);\n            $('#results-count').text(`\ud83c\udfaf ${data.length} r\u00e9sultat(s) trouv\u00e9(s)`);\n            $('#results').addClass('visible');\n        }\n        \n        \/\/ Soumission du formulaire\n        $('#audit-search-form').on('submit', function(e) {\n            e.preventDefault();\n            \n            $('#loading').addClass('active');\n            $('#error').removeClass('visible');\n            $('#results').removeClass('visible');\n            $('.qpa-search-btn').prop('disabled', true);\n            \n            const formData = $(this).serialize();\n            \n            $.ajax({\n                url: '<?php echo admin_url('admin-ajax.php'); ?>',\n                type: 'POST',\n                data: formData + '&action=pneumo_audit_search&nonce=<?php echo $nonce; ?>',\n                success: function(response) {\n                    $('#loading').removeClass('active');\n                    $('.qpa-search-btn').prop('disabled', false);\n                    \n                    if (response.success) {\n                        displayResults(response.data);\n                    } else {\n                        $('#error').addClass('visible').html(\n                            '<strong>\u274c Aucun r\u00e9sultat<\/strong><br>' + response.data\n                        );\n                    }\n                },\n                error: function() {\n                    $('#loading').removeClass('active');\n                    $('.qpa-search-btn').prop('disabled', false);\n                    $('#error').addClass('visible').html(\n                        '<strong>\u274c Erreur<\/strong><br>Erreur de connexion au serveur'\n                    );\n                }\n            });\n        });\n    });\n    \n    function copyNotes(id) {\n        const notesElement = document.getElementById('notes-' + id);\n        const textarea = document.createElement('textarea');\n        textarea.value = notesElement.textContent;\n        document.body.appendChild(textarea);\n        textarea.select();\n        document.execCommand('copy');\n        document.body.removeChild(textarea);\n        \n        const btn = event.target;\n        const originalText = btn.textContent;\n        btn.textContent = '\u2705 Copi\u00e9 !';\n        setTimeout(() => {\n            btn.textContent = originalText;\n        }, 2000);\n    }\n    <\/script>\n    \n    <?php\n    return ob_get_clean();\n}","tags":["audit","qualif-pneumo"],"active":true,"modified":"2025-11-10 16:25:06","revision":"1"}]}